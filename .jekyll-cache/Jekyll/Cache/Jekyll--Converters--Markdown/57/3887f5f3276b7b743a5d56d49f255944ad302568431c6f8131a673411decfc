I"¢O<p>spring bootå¯¹å¸¸ç”¨çš„æ•°æ®åº“æ”¯æŒå¤–ï¼Œå¯¹nosql æ•°æ®åº“ä¹Ÿè¿›è¡Œäº†å°è£…è‡ªåŠ¨åŒ–ã€‚</p>

<h2 id="redisä»‹ç»">redisä»‹ç»</h2>

<p>Redisæ˜¯ç›®å‰ä¸šç•Œä½¿ç”¨æœ€å¹¿æ³›çš„å†…å­˜æ•°æ®å­˜å‚¨ã€‚ç›¸æ¯”memcachedï¼ŒRedisæ”¯æŒæ›´ä¸°å¯Œçš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚hashes, lists, setsç­‰ï¼ŒåŒæ—¶æ”¯æŒæ•°æ®æŒä¹…åŒ–ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRedisè¿˜æä¾›ä¸€äº›ç±»æ•°æ®åº“çš„ç‰¹æ€§ï¼Œæ¯”å¦‚äº‹åŠ¡ï¼ŒHAï¼Œä¸»ä»åº“ã€‚å¯ä»¥è¯´Rediså…¼å…·äº†ç¼“å­˜ç³»ç»Ÿå’Œæ•°æ®åº“çš„ä¸€äº›ç‰¹æ€§ï¼Œå› æ­¤æœ‰ç€ä¸°å¯Œçš„åº”ç”¨åœºæ™¯ã€‚æœ¬æ–‡ä»‹ç»Redisåœ¨Spring Bootä¸­ä¸¤ä¸ªå…¸å‹çš„åº”ç”¨åœºæ™¯ã€‚</p>

<h2 id="å¦‚ä½•ä½¿ç”¨">å¦‚ä½•ä½¿ç”¨</h2>

<p>1ã€å¼•å…¥ spring-boot-starter-redis</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>  
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>  
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-redis<span class="nt">&lt;/artifactId&gt;</span>  
<span class="nt">&lt;/dependency&gt;</span>  
</code></pre></div></div>

<p>2ã€æ·»åŠ é…ç½®æ–‡ä»¶</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># REDIS (RedisProperties)
# Redisæ•°æ®åº“ç´¢å¼•ï¼ˆé»˜è®¤ä¸º0ï¼‰
</span><span class="py">spring.redis.database</span><span class="p">=</span><span class="s">0  </span>
<span class="c"># RedisæœåŠ¡å™¨åœ°å€
</span><span class="py">spring.redis.host</span><span class="p">=</span><span class="s">192.168.0.58</span>
<span class="c"># RedisæœåŠ¡å™¨è¿æ¥ç«¯å£
</span><span class="py">spring.redis.port</span><span class="p">=</span><span class="s">6379  </span>
<span class="c"># RedisæœåŠ¡å™¨è¿æ¥å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰
</span><span class="py">spring.redis.password</span><span class="p">=</span>  
<span class="c"># è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
</span><span class="s">spring.redis.pool.max-active=8  </span>
<span class="c"># è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
</span><span class="py">spring.redis.pool.max-wait</span><span class="p">=</span><span class="s">-1  </span>
<span class="c"># è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥
</span><span class="py">spring.redis.pool.max-idle</span><span class="p">=</span><span class="s">8  </span>
<span class="c"># è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥
</span><span class="py">spring.redis.pool.min-idle</span><span class="p">=</span><span class="s">0  </span>
<span class="c"># è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
</span><span class="py">spring.redis.timeout</span><span class="p">=</span><span class="s">0  </span>
</code></pre></div></div>

<p>3ã€æ·»åŠ cacheçš„é…ç½®ç±»</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableCaching</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisConfig</span> <span class="kd">extends</span> <span class="nc">CachingConfigurerSupport</span><span class="o">{</span>
	
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">KeyGenerator</span> <span class="nf">keyGenerator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">KeyGenerator</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">generate</span><span class="o">(</span><span class="nc">Object</span> <span class="n">target</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span> <span class="o">:</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">obj</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"rawtypes"</span><span class="o">)</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">CacheManager</span> <span class="nf">cacheManager</span><span class="o">(</span><span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">RedisCacheManager</span> <span class="n">rcm</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisCacheManager</span><span class="o">(</span><span class="n">redisTemplate</span><span class="o">);</span>
        <span class="c1">//è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´</span>
        <span class="c1">//rcm.setDefaultExpiration(60);//ç§’</span>
        <span class="k">return</span> <span class="n">rcm</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">redisTemplate</span><span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">factory</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">StringRedisTemplate</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringRedisTemplate</span><span class="o">(</span><span class="n">factory</span><span class="o">);</span>
        <span class="nc">Jackson2JsonRedisSerializer</span> <span class="n">jackson2JsonRedisSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Jackson2JsonRedisSerializer</span><span class="o">(</span><span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">ObjectMapper</span> <span class="n">om</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span>
        <span class="n">om</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="nc">PropertyAccessor</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="nc">JsonAutoDetect</span><span class="o">.</span><span class="na">Visibility</span><span class="o">.</span><span class="na">ANY</span><span class="o">);</span>
        <span class="n">om</span><span class="o">.</span><span class="na">enableDefaultTyping</span><span class="o">(</span><span class="nc">ObjectMapper</span><span class="o">.</span><span class="na">DefaultTyping</span><span class="o">.</span><span class="na">NON_FINAL</span><span class="o">);</span>
        <span class="n">jackson2JsonRedisSerializer</span><span class="o">.</span><span class="na">setObjectMapper</span><span class="o">(</span><span class="n">om</span><span class="o">);</span>
        <span class="n">template</span><span class="o">.</span><span class="na">setValueSerializer</span><span class="o">(</span><span class="n">jackson2JsonRedisSerializer</span><span class="o">);</span>
        <span class="n">template</span><span class="o">.</span><span class="na">afterPropertiesSet</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<p>3ã€å¥½äº†ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ç›´æ¥ä½¿ç”¨äº†</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringApplicationConfiguration</span><span class="o">(</span><span class="nc">Application</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestRedis</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">StringRedisTemplate</span> <span class="n">stringRedisTemplate</span><span class="o">;</span>
    
	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">,</span> <span class="s">"111"</span><span class="o">);</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">"111"</span><span class="o">,</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">));</span>
    <span class="o">}</span>
    
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testObj</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">User</span> <span class="n">user</span><span class="o">=</span><span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="s">"aa@126.com"</span><span class="o">,</span> <span class="s">"aa"</span><span class="o">,</span> <span class="s">"aa123456"</span><span class="o">,</span> <span class="s">"aa"</span><span class="o">,</span><span class="s">"123"</span><span class="o">);</span>
        <span class="nc">ValueOperations</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">User</span><span class="o">&gt;</span> <span class="n">operations</span><span class="o">=</span><span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">();</span>
        <span class="n">operations</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"com.neox"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="n">operations</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"com.neo.f"</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="c1">//redisTemplate.delete("com.neo.f");</span>
        <span class="kt">boolean</span> <span class="n">exists</span><span class="o">=</span><span class="n">redisTemplate</span><span class="o">.</span><span class="na">hasKey</span><span class="o">(</span><span class="s">"com.neo.f"</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">exists</span><span class="o">){</span>
        	<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"exists is true"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
        	<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"exists is false"</span><span class="o">);</span>
        <span class="o">}</span>
       <span class="c1">// Assert.assertEquals("aa", operations.get("com.neo.f").getUserName());</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>ä»¥ä¸Šéƒ½æ˜¯æ‰‹åŠ¨ä½¿ç”¨çš„æ–¹å¼ï¼Œå¦‚ä½•åœ¨æŸ¥æ‰¾æ•°æ®åº“çš„æ—¶å€™è‡ªåŠ¨ä½¿ç”¨ç¼“å­˜å‘¢ï¼Œçœ‹ä¸‹é¢ï¼›</p>

<p>4ã€è‡ªåŠ¨æ ¹æ®æ–¹æ³•ç”Ÿæˆç¼“å­˜</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/getUser"</span><span class="o">)</span>
<span class="nd">@Cacheable</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">"user-key"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">User</span> <span class="nf">getUser</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">User</span> <span class="n">user</span><span class="o">=</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findByUserName</span><span class="o">(</span><span class="s">"aa"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è‹¥ä¸‹é¢æ²¡å‡ºç°â€œæ— ç¼“å­˜çš„æ—¶å€™è°ƒç”¨â€å­—æ ·ä¸”èƒ½æ‰“å°å‡ºæ•°æ®è¡¨ç¤ºæµ‹è¯•æˆåŠŸ"</span><span class="o">);</span>  
    <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>å…¶ä¸­valueçš„å€¼å°±æ˜¯ç¼“å­˜åˆ°redisä¸­çš„key</p>

<h2 id="å…±äº«session-spring-session-data-redis">å…±äº«Session-spring-session-data-redis</h2>

<p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œsessiongå…±äº«æœ‰å¾ˆå¤šçš„è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­æ‰˜ç®¡åˆ°ç¼“å­˜ä¸­åº”è¯¥æ˜¯æœ€å¸¸ç”¨çš„æ–¹æ¡ˆä¹‹ä¸€ï¼Œ</p>

<h3 id="spring-sessionå®˜æ–¹è¯´æ˜">Spring Sessionå®˜æ–¹è¯´æ˜</h3>

<p>Spring Session provides an API and implementations for managing a userâ€™s session information.</p>

<h3 id="å¦‚ä½•ä½¿ç”¨-1">å¦‚ä½•ä½¿ç”¨</h3>

<p>1ã€å¼•å…¥ä¾èµ–</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.session<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-session-data-redis<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2ã€Sessioné…ç½®ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableRedisHttpSession</span><span class="o">(</span><span class="n">maxInactiveIntervalInSeconds</span> <span class="o">=</span> <span class="mi">86400</span><span class="o">*</span><span class="mi">30</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SessionConfig</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>maxInactiveIntervalInSeconds: è®¾ç½®Sessionå¤±æ•ˆæ—¶é—´ï¼Œä½¿ç”¨Redis Sessionä¹‹åï¼ŒåŸBootçš„server.session.timeoutå±æ€§ä¸å†ç”Ÿæ•ˆ</p>
</blockquote>

<p>å¥½äº†ï¼Œè¿™æ ·å°±é…ç½®å¥½äº†ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹</p>

<p>3ã€æµ‹è¯•</p>

<p>æ·»åŠ æµ‹è¯•æ–¹æ³•è·å–sessionid</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/uid"</span><span class="o">)</span>
    <span class="nc">String</span> <span class="nf">uid</span><span class="o">(</span><span class="nc">HttpSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">UUID</span> <span class="n">uid</span> <span class="o">=</span> <span class="o">(</span><span class="no">UUID</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"uid"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">uid</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">session</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"uid"</span><span class="o">,</span> <span class="n">uid</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>ç™»å½•redis è¾“å…¥ <code class="highlighter-rouge">keys '*sessions*'</code></p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>t<span class="nt">&lt;spring:session:sessions:db031986-8ecc-48d6-b471-b137a3ed6bc4</span>
<span class="err">t(spring:session:expirations:1472976480000</span>
</code></pre></div></div>
<p>å…¶ä¸­ 1472976480000ä¸ºå¤±æ•ˆæ—¶é—´ï¼Œæ„æ€æ˜¯è¿™ä¸ªæ—¶é—´åsessionå¤±æ•ˆï¼Œ<code class="highlighter-rouge">db031986-8ecc-48d6-b471-b137a3ed6bc4</code> ä¸ºsessionId,ç™»å½•http://localhost:8080/uid å‘ç°ä¼šä¸€è‡´ï¼Œå°±è¯´æ˜session å·²ç»åœ¨redisé‡Œé¢è¿›è¡Œæœ‰æ•ˆçš„ç®¡ç†äº†ã€‚</p>

<h3 id="å¦‚ä½•åœ¨ä¸¤å°æˆ–è€…å¤šå°ä¸­å…±äº«session">å¦‚ä½•åœ¨ä¸¤å°æˆ–è€…å¤šå°ä¸­å…±äº«session</h3>

<p>å…¶å®å°±æ˜¯æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤åœ¨å¦ä¸€ä¸ªé¡¹ç›®ä¸­å†æ¬¡é…ç½®ä¸€æ¬¡ï¼Œå¯åŠ¨åè‡ªåŠ¨å°±è¿›è¡Œäº†sessionå…±äº«ã€‚</p>

<p><strong><a href="https://github.com/ityouknow/spring-boot-examples">ç¤ºä¾‹ä»£ç -github</a></strong></p>

<p><strong><a href="https://gitee.com/ityouknow/spring-boot-examples">ç¤ºä¾‹ä»£ç -ç äº‘</a></strong></p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<p><a href="http://emacoo.cn/blog/spring-redis">Redisçš„ä¸¤ä¸ªå…¸å‹åº”ç”¨åœºæ™¯</a><br />
<a href="https://segmentfault.com/a/1190000004358410">SpringBootåº”ç”¨ä¹‹åˆ†å¸ƒå¼ä¼šè¯</a></p>

<hr />

<p><strong>ä½œè€…ï¼šçº¯æ´çš„å¾®ç¬‘</strong><br />
<strong>å‡ºå¤„ï¼š<a href="http://www.ityouknow.com">www.ityouknow.com</a></strong>    <br />
<strong>ç‰ˆæƒæ‰€æœ‰ï¼Œæ¬¢è¿ä¿ç•™åŸæ–‡é“¾æ¥è¿›è¡Œè½¬è½½ï¼š)</strong></p>
:ET