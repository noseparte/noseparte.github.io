I"¯Å<p>â€¦</p>
<h1 id="java-çº¿ç¨‹æ± çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿">Java çº¿ç¨‹æ± çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿</h1>

<ul>
  <li><a href="#çº¿ç¨‹æ± threadPool">ThreadPool çº¿ç¨‹æ± çš„å®šä¹‰? å¦‚ä½•åˆ›å»º?</a></li>
  <li><a href="#threadPoolExecutor">é…ç½® ThreadPoolExecutor</a></li>
  <li><a href="#blockingQueue">ç®¡ç†ä»»åŠ¡é˜Ÿåˆ— BlockingQueue</a></li>
  <li><a href="#rejectedExecutionHandler">é¥±å’Œç­–ç•¥ RejectedExecutionHandler</a></li>
  <li><a href="#executors">[ä¸æ¨è] ä½¿ç”¨Executorså·¥å‚æ¨¡å¼åˆ›å»ºçº¿ç¨‹æ± </a></li>
  <li><a href="#executorService">ExecutorServiceçš„ç”Ÿå‘½å‘¨æœŸ</a></li>
  <li><a href="#threadFactory">çº¿ç¨‹å·¥å‚ ThreadFactory</a>
    <ul>
      <li><a href="#defaultThreadFactory">DefaultThreadFactory</a></li>
      <li><a href="#privilegedThreadFactory">PrivilegedThreadFactory</a></li>
      <li><a href="#threadFactoryBuilder">[æ¨è] ä½¿ç”¨guavaçš„ ThreadFactoryBuilder</a></li>
    </ul>
  </li>
  <li><a href="#end">åˆ›å»ºçº¿ç¨‹æ± çš„æ­£ç¡®å§¿åŠ¿</a></li>
</ul>

<h2 id="çº¿ç¨‹æ± -threadpool">çº¿ç¨‹æ±  ThreadPool</h2>

<blockquote>
  <p><strong>1. çº¿ç¨‹æ± çš„å®šä¹‰ï¼š</strong></p>
</blockquote>

<p>ï¼ˆæ‘˜è‡ª<a href="https://zq-mobile.zhaopin.com/mAnswer/6161026/">èŒQ</a>ï¼‰åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œåˆ›å»ºå’Œé”€æ¯å¯¹è±¡æ˜¯å¾ˆè´¹æ—¶é—´çš„ï¼Œå› ä¸ºåˆ›å»ºä¸€ä¸ªå¯¹è±¡è¦è·å–å†…å­˜èµ„æºæˆ–è€…å…¶å®ƒæ›´å¤šèµ„æºã€‚åœ¨Javaä¸­æ›´æ˜¯å¦‚æ­¤ï¼Œè™šæ‹Ÿæœºå°†è¯•å›¾è·Ÿè¸ªæ¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»¥ä¾¿èƒ½å¤Ÿåœ¨å¯¹è±¡é”€æ¯åè¿›è¡Œåƒåœ¾å›æ”¶ã€‚æ‰€ä»¥æé«˜æœåŠ¡ç¨‹åºæ•ˆç‡çš„ä¸€ä¸ªæ‰‹æ®µå°±æ˜¯å°½å¯èƒ½å‡å°‘åˆ›å»ºå’Œé”€æ¯å¯¹è±¡çš„æ¬¡æ•°ï¼Œç‰¹åˆ«æ˜¯ä¸€äº›å¾ˆè€—èµ„æºçš„å¯¹è±¡åˆ›å»ºå’Œé”€æ¯ï¼Œè¿™å°±æ˜¯â€æ± åŒ–èµ„æºâ€æŠ€æœ¯äº§ç”Ÿçš„åŸå› ã€‚çº¿ç¨‹æ± é¡¾åæ€ä¹‰å°±æ˜¯äº‹å…ˆåˆ›å»ºè‹¥å¹²ä¸ªå¯æ‰§è¡Œçš„çº¿ç¨‹æ”¾å…¥ä¸€ä¸ªæ± ï¼ˆå®¹å™¨ï¼‰ä¸­ï¼Œéœ€è¦çš„æ—¶å€™ä»æ± ä¸­è·å–çº¿ç¨‹ä¸ç”¨è‡ªè¡Œåˆ›å»ºï¼Œä½¿ç”¨å®Œæ¯•ä¸éœ€è¦é”€æ¯çº¿ç¨‹è€Œæ˜¯æ”¾å›æ± ä¸­ï¼Œä»è€Œå‡å°‘åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¯¹è±¡çš„å¼€é”€ã€‚</p>

<blockquote>
  <p><strong>2. å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± ï¼š</strong></p>
</blockquote>

<ul>
  <li><strong>ä½¿ç”¨ ThreadPoolExecutorï¼š</strong>
ThreadPoolExecutoræ˜¯ä¸€ä¸ªçµæ´»çš„ã€ç¨³å®šçš„çº¿ç¨‹æ± ï¼Œå…è®¸è¿›è¡Œå®šåˆ¶ã€‚</li>
  <li><strong>ä½¿ç”¨ Executorsï¼š</strong>
Executorsä¸­çš„é™æ€å·¥å‚æ–¹æ³•ä¹‹ä¸€æ¥åˆ›å»ºçº¿ç¨‹æ± ï¼š
<strong>newSingleThreadExecutorï¼š</strong> æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„Executorï¼Œå®ƒåˆ›å»ºå•ä¸ªå·¥ä½œè€…çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœè¿™ä¸ªçº¿ç¨‹å¼‚å¸¸ç»“æŸï¼Œä¼šåˆ›å»ºå¦ä¸€ä¸ªçº¿ç¨‹æ¥æ›¿ä»£ã€‚newSingleThreadExecutorèƒ½ç¡®ä¿ä¾ç…§ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­çš„é¡ºåºæ¥ä¸²è¡Œæ‰§è¡Œ(ä¾‹å¦‚ FIFOã€LIFOã€ä¼˜å…ˆçº§)ã€‚
<strong>newFixedThreadPoolï¼š</strong> å°†åˆ›å»ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„çº¿ç¨‹æ± ï¼Œæ¯å½“æäº¤ä¸€ä¸ªä»»åŠ¡æ—¶å°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œç›´åˆ°è¾¾åˆ°çº¿ç¨‹æ± çš„æœ€å¤§æ•°é‡ï¼Œè¿™æ—¶çº¿ç¨‹æ± çš„è§„æ¨¡å°†ä¸å†å‘ç”Ÿå˜åŒ–(å¦‚æœæŸä¸ªçº¿ç¨‹ç”±äºå‘ç”Ÿäº†æœªé¢„æœŸçš„Exceptionè€Œç»“æŸï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šè¡¥å……ä¸€ä¸ªæ–°çš„çº¿ç¨‹)ã€‚
<strong>newCachedThreadPoolï¼š</strong> å°†åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çš„çº¿ç¨‹æ± ï¼Œå¦‚æœçº¿ç¨‹æ± çš„å½“å‰è§„æ¨¡è¶…è¿‡äº†å¤„ç†éœ€æ±‚æ—¶ï¼Œé‚£ä¹ˆå°†å›æ”¶ç©ºé—²çš„çº¿ç¨‹ï¼Œè€Œå½“éœ€æ±‚å¢åŠ æ—¶ï¼Œåˆ™å¯ä»¥æ·»åŠ æ–°çš„çº¿ç¨‹ï¼Œçº¿ç¨‹æ± è§„æ¨¡ä¸å­˜åœ¨ä»»ä½•é™åˆ¶ã€‚
<strong>newScheduledThreadExecutorï¼š</strong> åˆ›å»ºäº†ä¸€ä¸ªå›ºå®šé•¿åº¦çš„çº¿ç¨‹æ± ï¼Œè€Œä¸”ä»¥å»¶è¿Ÿæˆ–å®šæ—¶çš„æ–¹å¼æ¥æ‰§è¡Œä»»åŠ¡ï¼Œç±»ä¼¼äºTimerã€‚</li>
</ul>

<h2 id="é…ç½®-threadpoolexecutor">é…ç½® ThreadPoolExecutor</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPoolExecutor</span> <span class="o">{</span>
    
    <span class="c1">// çº¿ç¨‹æ± ç»´æŠ¤çš„æœ€å°çº¿ç¨‹æ•°</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">;</span>
    <span class="c1">// çº¿ç¨‹æ± å¯å®¹çº³çº¿ç¨‹æ•°çš„æœ€å¤§å€¼</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">;</span>
    <span class="c1">// çº¿ç¨‹æ± è¾¾åˆ°é˜ˆå€¼åï¼Œæ–°çš„çº¿ç¨‹éœ€è¦ç­‰å¾…çš„æ—¶é—´</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">;</span>
    <span class="c1">// ä»¥å·¥å‚æ¨¡å¼åˆ›å»ºæ–°çš„çº¿ç¨‹</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">;</span>
    <span class="c1">// ä¸Šä¸‹æ–‡</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AccessControlContext</span> <span class="n">acc</span><span class="o">;</span>
    <span class="c1">// é˜»å¡é˜Ÿåˆ—</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">;</span>
    <span class="c1">// æ‹’ç»ç­–ç•¥</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">;</span>
    
    <span class="cm">/**
     * ThreadPoolExecutorçš„æ ¸å¿ƒæ„é€ å™¨
     */</span>
    <span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span><span class="err">Â </span>
                                       <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span><span class="err">Â </span>
                                       <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
                                       <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">,</span><span class="err">Â Â </span>
                                       <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
                                       <span class="nc">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span>
                                       <span class="nc">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">corePoolSize</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span><span class="err">Â Â Â </span> 
              <span class="n">maximumPoolSize</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span><span class="err">Â Â Â </span>
              <span class="n">maximumPoolSize</span> <span class="o">&lt;</span> <span class="n">corePoolSize</span> <span class="o">||</span><span class="err">Â Â Â </span> 
              <span class="n">keepAliveTime</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span><span class="err">Â Â Â </span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">();</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">workQueue</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">threadFactory</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">handler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span><span class="err">Â Â Â </span> 
              <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
           <span class="k">this</span><span class="o">.</span><span class="na">acc</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span><span class="err">Â Â Â Â Â </span>
                    <span class="kc">null</span> <span class="o">:</span><span class="err">Â Â Â Â Â Â Â </span> 
                    <span class="nc">AccessController</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
           <span class="k">this</span><span class="o">.</span><span class="na">corePoolSize</span> <span class="o">=</span> <span class="n">corePoolSize</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">maximumPoolSize</span> <span class="o">=</span> <span class="n">maximumPoolSize</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">workQueue</span> <span class="o">=</span> <span class="n">workQueue</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">keepAliveTime</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">keepAliveTime</span><span class="o">);</span>
           <span class="k">this</span><span class="o">.</span><span class="na">threadFactory</span> <span class="o">=</span> <span class="n">threadFactory</span><span class="o">;</span>
           <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
    <span class="o">}</span>
    
<span class="o">}</span>
</code></pre></div></div>

<h2 id="ç®¡ç†ä»»åŠ¡é˜Ÿåˆ—-blockingqueue">ç®¡ç†ä»»åŠ¡é˜Ÿåˆ— BlockingQueue</h2>

<p><strong>ThreadPoolExecutor</strong>å…è®¸æä¾›ä¸€ä¸ª<strong>BlockingQueue</strong>æ¥ä¿å­˜ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚åŸºæœ¬çš„ä»»åŠ¡æ’é˜Ÿæ–¹æ³•æœ‰3ç§ï¼šæ— ç•Œé˜Ÿåˆ—ã€æœ‰ç•Œé˜Ÿåˆ—å’ŒåŒæ­¥ç§»äº¤(Synchronous Handoff)ã€‚</p>

<ul>
  <li><strong>æ— ç•Œé˜Ÿåˆ—ï¼š</strong> é˜Ÿåˆ—å¤§å°æ— é™åˆ¶ï¼Œå¸¸ç”¨çš„ä¸ºæ— ç•Œçš„LinkedBlockingQueueï¼Œä½¿ç”¨è¯¥é˜Ÿåˆ—åšä¸ºé˜»å¡é˜Ÿåˆ—æ—¶è¦å°¤å…¶å½“å¿ƒï¼Œå½“ä»»åŠ¡è€—æ—¶è¾ƒé•¿æ—¶å¯èƒ½ä¼šå¯¼è‡´å¤§é‡æ–°ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­å †ç§¯æœ€ç»ˆå¯¼è‡´OOMã€‚
é˜…è¯»ä»£ç å‘ç°ï¼ŒExecutors.newFixedThreadPool é‡‡ç”¨å°±æ˜¯ LinkedBlockingQueueï¼Œè€Œæ¥¼ä¸»è¸©åˆ°çš„å°±æ˜¯è¿™ä¸ªå‘ï¼Œå½“QPSå¾ˆé«˜ï¼Œå‘é€æ•°æ®å¾ˆå¤§ï¼Œå¤§é‡çš„ä»»åŠ¡è¢«æ·»åŠ åˆ°è¿™ä¸ªæ— ç•ŒLinkedBlockingQueue ä¸­ï¼Œå¯¼è‡´cpuå’Œå†…å­˜é£™å‡æœåŠ¡å™¨æŒ‚æ‰ã€‚</li>
  <li><strong>æœ‰ç•Œé˜Ÿåˆ—ï¼š</strong> å¸¸ç”¨çš„æœ‰ä¸¤ç±»ï¼Œ
ä¸€ç±»æ˜¯éµå¾ªFIFOåŸåˆ™çš„é˜Ÿåˆ—å¦‚ArrayBlockingQueueä¸æœ‰ç•Œçš„LinkedBlockingQueueï¼Œ
å¦ä¸€ç±»æ˜¯ä¼˜å…ˆçº§é˜Ÿåˆ—å¦‚PriorityBlockingQueueã€‚PriorityBlockingQueueä¸­çš„ä¼˜å…ˆçº§ç”±ä»»åŠ¡çš„Comparatorå†³å®šã€‚
ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—æ—¶é˜Ÿåˆ—å¤§å°éœ€å’Œçº¿ç¨‹æ± å¤§å°äº’ç›¸é…åˆï¼Œçº¿ç¨‹æ± è¾ƒå°æœ‰ç•Œé˜Ÿåˆ—è¾ƒå¤§æ—¶å¯å‡å°‘å†…å­˜æ¶ˆè€—ï¼Œé™ä½cpuä½¿ç”¨ç‡å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ˜¯å¯èƒ½ä¼šé™åˆ¶ç³»ç»Ÿååé‡ã€‚åœ¨æˆ‘ä»¬çš„ä¿®å¤æ–¹æ¡ˆä¸­ï¼Œé€‰æ‹©çš„å°±æ˜¯è¿™ä¸ªç±»å‹çš„é˜Ÿåˆ—ï¼Œè™½ç„¶ä¼šæœ‰éƒ¨åˆ†ä»»åŠ¡è¢«ä¸¢å¤±ï¼Œä½†æ˜¯æˆ‘ä»¬çº¿ä¸Šæ˜¯æ’åºæ—¥å¿—æœé›†ä»»åŠ¡ï¼Œæ‰€ä»¥å¯¹éƒ¨åˆ†å¯¹ä¸¢å¤±æ˜¯å¯ä»¥å®¹å¿çš„ã€‚</li>
  <li><strong>åŒæ­¥ç§»äº¤é˜Ÿåˆ—ï¼š</strong> å¦‚æœä¸å¸Œæœ›ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…è€Œæ˜¯å¸Œæœ›å°†ä»»åŠ¡ç›´æ¥ç§»äº¤ç»™å·¥ä½œçº¿ç¨‹ï¼Œå¯ä½¿ç”¨SynchronousQueueä½œä¸ºç­‰å¾…é˜Ÿåˆ—ã€‚SynchronousQueueä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯ä¸€ç§çº¿ç¨‹ä¹‹é—´ç§»äº¤çš„æœºåˆ¶ã€‚è¦å°†ä¸€ä¸ªå…ƒç´ æ”¾å…¥SynchronousQueueä¸­ï¼Œå¿…é¡»æœ‰å¦ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾…æ¥æ”¶è¿™ä¸ªå…ƒç´ ã€‚åªæœ‰åœ¨ä½¿ç”¨æ— ç•Œçº¿ç¨‹æ± æˆ–è€…æœ‰é¥±å’Œç­–ç•¥æ—¶æ‰å»ºè®®ä½¿ç”¨è¯¥é˜Ÿåˆ—ã€‚</li>
</ul>

<h2 id="é¥±å’Œç­–ç•¥-rejectedexecutionhandler">é¥±å’Œç­–ç•¥ RejectedExecutionHandler</h2>

<blockquote>
  <p>ThreadPoolExecutoræä¾›å¦‚ä¸‹4ç§é¥±å’Œç­–ç•¥:</p>
</blockquote>

<ul>
  <li><strong>CallerRunsPolicy</strong> ç”±è°ƒç”¨çº¿ç¨‹ï¼ˆæäº¤ä»»åŠ¡çš„çº¿ç¨‹ï¼‰å¤„ç†è¯¥ä»»åŠ¡</li>
  <li><strong>AbortPolicy</strong> ä¸¢å¼ƒä»»åŠ¡å¹¶ç›´æ¥æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸(é»˜è®¤çš„çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥)</li>
  <li><strong>DiscardPolicy</strong> ä»…ä¸¢å¼ƒä»»åŠ¡å¹¶ä¸æŠ›å‡ºå¼‚å¸¸</li>
  <li><strong>DiscardOldestPolicy</strong> ä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°æäº¤è¢«æ‹’ç»çš„ä»»åŠ¡</li>
</ul>

<p>è‡ªå®šä¹‰é¥±å’Œç­–ç•¥ï¼Œåªéœ€å®ç°<strong>RejectedExecutionHandler</strong>æ¥å£å¹¶é‡å†™<strong>void rejectedExecution(Runnable r, ThreadPoolExecutor executor)</strong> æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPoolExecutor</span><span class="o">{</span>

    <span class="cm">/** 
     *  é»˜è®¤çš„çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥ AbortPolicy
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">RejectedExecutionHandler</span> <span class="n">defaultHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AbortPolicy</span><span class="o">();</span>

    <span class="cm">/* ThreadPoolExecutoræä¾›å¦‚ä¸‹4ä¸­æ‹’ç»ç­–ç•¥: */</span>
    <span class="cm">/**
     * ç”±è°ƒç”¨çº¿ç¨‹ï¼ˆæäº¤ä»»åŠ¡çš„çº¿ç¨‹ï¼‰å¤„ç†è¯¥ä»»åŠ¡
     */</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CallerRunsPolicy</span> <span class="kd">implements</span> <span class="nc">RejectedExecutionHandler</span> <span class="o">{}</span>
 
    <span class="cm">/** 
     *  ä¸¢å¼ƒä»»åŠ¡å¹¶ç›´æ¥æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸
     */</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AbortPolicy</span> <span class="kd">implements</span> <span class="nc">RejectedExecutionHandler</span> <span class="o">{}</span>
 
   <span class="cm">/** 
    * ä»…ä¸¢å¼ƒä»»åŠ¡å¹¶ä¸æŠ›å‡ºå¼‚å¸¸
    */</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiscardPolicy</span> <span class="kd">implements</span> <span class="nc">RejectedExecutionHandler</span> <span class="o">{}</span>
   
   <span class="cm">/** 
    * ä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°æäº¤è¢«æ‹’ç»çš„ä»»åŠ¡
    */</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiscardOldestPolicy</span> <span class="kd">implements</span> <span class="nc">RejectedExecutionHandler</span> <span class="o">{}</span>

<span class="o">}</span>
</code></pre></div></div>

<h2 id="executorsä¸æ¨è">Executors(ä¸æ¨è)</h2>

<p>åœ¨é˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œä¸­æåˆ°ï¼Œä½¿ç”¨Executorsåˆ›å»ºçº¿ç¨‹æ± å¯èƒ½ä¼šå¯¼è‡´OOM(OutOfMemory ,å†…å­˜æº¢å‡º)</p>

<p><img src="https://github.com/AwakenCN/Almost-Famous/blob/aedc643ad298225a54aa1af19e877e45f03f0ff9/famous-static/images/blockingQueue.png?raw=true" alt="BlockingQueueè‡´ä½¿OOMç¤ºæ„å›¾" /></p>

<h2 id="executorservice">ExecutorService</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ExecutorService</span> <span class="kd">extends</span> <span class="nc">Executor</span> <span class="o">{</span><span class="err">Â Â </span>
     <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">();</span><span class="err">Â Â Â </span> 
     <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span> <span class="nf">shutdownNow</span><span class="o">();</span><span class="err">Â Â Â </span> 
     <span class="kt">boolean</span> <span class="nf">isShutdown</span><span class="o">();</span><span class="err">Â Â Â </span> 
     <span class="kt">boolean</span> <span class="nf">isTerminated</span><span class="o">();</span><span class="err">Â Â Â </span> 
     <span class="kt">boolean</span> <span class="nf">awaitTermination</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span><span class="err">Â </span><span class="kd">throws</span> <span class="nc">InterruptedException</span><span class="o">;</span><span class="err">Â Â </span>
     <span class="c1">// .......å…¶ä»–ç”¨äºä»»åŠ¡æäº¤çš„æ–¹æ³•   </span>
<span class="o">}</span>    
</code></pre></div></div>

<p>ä¸ºäº†è§£å†³æ‰§è¡ŒæœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼Œ
<strong>ExecutorService</strong>æ‹“å±•äº†Executoræ¥å£ï¼Œæ·»åŠ äº†ä¸€äº›ç”¨äºç”Ÿå‘½å‘¨æœŸç®¡ç†çš„æ–¹æ³•ã€‚
<strong>ExecutorService</strong>çš„ç”Ÿå‘½å‘¨æœŸæœ‰3ç§çŠ¶æ€ï¼šè¿è¡Œã€å…³é—­å’Œå·²ç»ˆæ­¢ã€‚
<strong>ExecutorService</strong>åœ¨åˆå§‹åˆ›å»ºæ—¶å¤„äºè¿è¡ŒçŠ¶æ€ã€‚
<strong>shutdown</strong>æ–¹æ³•å°†æ‰§è¡Œå¹³ç¼“çš„å…³é—­è¿‡ç¨‹ï¼šä¸å†æ¥å—æ–°çš„ä»»åŠ¡ï¼ŒåŒæ—¶ç­‰å¾…å·²ç»æäº¤çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆâ€”â€”åŒ…æ‹¬é‚£äº›è¿˜æœªå¼€å§‹æ‰§è¡Œçš„ä»»åŠ¡ã€‚
<strong>shutdownNow</strong>æ–¹æ³•å°†æ‰§è¡Œç²—æš´çš„å…³é—­è¿‡ç¨‹ï¼šå®ƒå°†å°è¯•å–æ¶ˆæ‰€æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¸å†å¯åŠ¨é˜Ÿåˆ—ä¸­å°šæœªå¼€å§‹æ‰§è¡Œçš„ä»»åŠ¡ã€‚</p>

<h2 id="threadfactory">ThreadFactory</h2>

<h3 id="defaultthreadfactory">DefaultThreadFactory</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cm">/** * The default thread factory */</span>
<span class="kd">static</span> <span class="kd">class</span> <span class="nc">DefaultThreadFactory</span> <span class="kd">implements</span> <span class="nc">ThreadFactory</span> <span class="o">{</span><span class="err">Â Â </span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">poolNumber</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span><span class="err">Â Â Â </span> 
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ThreadGroup</span> <span class="n">group</span><span class="o">;</span><span class="err">Â Â Â </span> 
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">threadNumber</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span><span class="err">Â Â Â </span> 
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">namePrefix</span><span class="o">;</span><span class="err">Â Â Â </span> 
    
        <span class="nc">DefaultThreadFactory</span><span class="o">()</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â </span> 
            <span class="nc">SecurityManager</span> <span class="n">s</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">();</span><span class="err">Â Â Â Â Â Â Â </span> 
            <span class="n">group</span> <span class="o">=</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">getThreadGroup</span><span class="o">()</span> <span class="o">:</span><span class="err">Â </span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getThreadGroup</span><span class="o">();</span><span class="err">Â Â Â Â Â Â Â </span> 
            <span class="n">namePrefix</span> <span class="o">=</span> <span class="s">"pool-"</span> <span class="o">+</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                              <span class="n">poolNumber</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span> <span class="o">+</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                              <span class="s">"-thread-"</span><span class="o">;</span><span class="err">Â Â Â </span> 
        <span class="o">}</span><span class="err">Â Â Â </span> 
    
        <span class="kd">public</span> <span class="nc">Thread</span> <span class="nf">newThread</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â </span>
            <span class="nc">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                            <span class="n">namePrefix</span> <span class="o">+</span> <span class="n">threadNumber</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">(),</span>
                            <span class="mi">0</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">isDaemon</span><span class="o">())</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
                <span class="n">t</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span><span class="err">Â Â Â Â Â Â Â </span>
            <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getPriority</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">NORM_PRIORITY</span><span class="o">)</span><span class="err">Â Â Â Â Â Â </span>
                <span class="n">t</span><span class="o">.</span><span class="na">setPriority</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">NORM_PRIORITY</span><span class="o">);</span><span class="err">Â Â Â Â Â Â Â </span>
            <span class="k">return</span> <span class="n">t</span><span class="o">;</span><span class="err">Â Â Â </span>
        <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="privilegedthreadfactory">PrivilegedThreadFactory</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æƒé™è®¿é—®ä¸ç±»åŠ è½½
 */</span>
<span class="kd">static</span> <span class="kd">class</span> <span class="nc">PrivilegedThreadFactory</span> <span class="kd">extends</span> <span class="nc">DefaultThreadFactory</span> <span class="o">{</span><span class="err">Â Â Â </span> 

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AccessControlContext</span> <span class="n">acc</span><span class="o">;</span><span class="err">Â Â Â </span> 
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ClassLoader</span> <span class="n">ccl</span><span class="o">;</span><span class="err">Â Â Â </span> 
    <span class="nc">PrivilegedThreadFactory</span><span class="o">()</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="kd">super</span><span class="o">();</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="nc">SecurityManager</span> <span class="n">sm</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">();</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="k">if</span> <span class="o">(</span><span class="n">sm</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="c1">// Calls to getContextClassLoader from this classÂ Â Â Â Â Â Â Â Â Â Â </span>
            <span class="c1">// never trigger a security check, but we checkÂ Â Â Â Â Â Â Â Â Â Â  </span>
            <span class="c1">// whether our callers have this permission anyways.Â Â Â Â Â Â Â Â Â Â Â  </span>
            <span class="n">sm</span><span class="o">.</span><span class="na">checkPermission</span><span class="o">(</span><span class="nc">SecurityConstants</span><span class="o">.</span><span class="na">GET_CLASSLOADER_PERMISSION</span><span class="o">);</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="c1">// Fail fastÂ Â Â Â Â Â Â Â Â Â Â  </span>
            <span class="n">sm</span><span class="o">.</span><span class="na">checkPermission</span><span class="o">(</span><span class="k">new</span> <span class="nc">RuntimePermission</span><span class="o">(</span><span class="s">"setContextClassLoader"</span><span class="o">));</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="o">}</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="k">this</span><span class="o">.</span><span class="na">acc</span> <span class="o">=</span> <span class="nc">AccessController</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="k">this</span><span class="o">.</span><span class="na">ccl</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span><span class="err">Â Â Â </span> 
    <span class="o">}</span><span class="err">Â Â Â </span> 
    
    <span class="kd">public</span> <span class="nc">Thread</span> <span class="nf">newThread</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Runnable</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">newThread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;()</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                    <span class="kd">public</span> <span class="nc">Void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span><span class="err">Â Â Â </span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setContextClassLoader</span><span class="o">(</span><span class="n">ccl</span><span class="o">);</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                        <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                         <span class="k">return</span> <span class="kc">null</span><span class="o">;</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span>
                    <span class="o">}</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                <span class="o">},</span> <span class="n">acc</span><span class="o">);</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="o">}</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="o">});</span><span class="err">Â Â Â </span> 
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="ä½¿ç”¨guavaçš„-threadfactorybuilder">ä½¿ç”¨guavaçš„ ThreadFactoryBuilder</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadFactoryBuilder</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ThreadFactory</span> <span class="nf">doBuild</span><span class="o">(</span><span class="nc">ThreadFactoryBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span><span class="err">Â </span> 
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">nameFormat</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">nameFormat</span><span class="o">;</span><span class="err">Â </span> 
        <span class="kd">final</span> <span class="nc">Boolean</span> <span class="n">daemon</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">daemon</span><span class="o">;</span><span class="err">Â </span> 
        <span class="kd">final</span> <span class="nc">Integer</span> <span class="n">priority</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">priority</span><span class="o">;</span><span class="err">Â </span> 
        <span class="kd">final</span> <span class="nc">UncaughtExceptionHandler</span> <span class="n">uncaughtExceptionHandler</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">uncaughtExceptionHandler</span><span class="o">;</span><span class="err">Â </span> 
        <span class="kd">final</span> <span class="nc">ThreadFactory</span> <span class="n">backingThreadFactory</span> <span class="o">=</span><span class="err">Â Â Â Â Â </span> 
             <span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">backingThreadFactory</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span><span class="err">Â Â Â Â Â Â Â Â Â </span> 
                <span class="o">?</span> <span class="n">builder</span><span class="o">.</span><span class="na">backingThreadFactory</span><span class="err">Â Â Â Â Â Â Â Â Â </span>
                <span class="o">:</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">defaultThreadFactory</span><span class="o">();</span><span class="err">Â </span> 
        <span class="kd">final</span> <span class="nc">AtomicLong</span> <span class="n">count</span> <span class="o">=</span> <span class="o">(</span><span class="n">nameFormat</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">AtomicLong</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span><span class="err">Â </span> 
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ThreadFactory</span><span class="o">()</span> <span class="o">{</span><span class="err">Â Â Â </span> 
            <span class="nd">@Override</span><span class="err">Â Â Â </span> 
            <span class="kd">public</span> <span class="nc">Thread</span> <span class="nf">newThread</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">runnable</span><span class="o">)</span> <span class="o">{</span><span class="err">Â Â Â Â Â </span> 
                <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">backingThreadFactory</span><span class="o">.</span><span class="na">newThread</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span><span class="err">Â Â Â Â Â </span> 
                <span class="k">if</span> <span class="o">(</span><span class="n">nameFormat</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â </span> 
                    <span class="n">thread</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">format</span><span class="o">(</span><span class="n">nameFormat</span><span class="o">,</span> <span class="n">count</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()));</span><span class="err">Â Â Â Â Â </span> 
                <span class="o">}</span><span class="err">Â Â Â Â Â </span>
                <span class="k">if</span> <span class="o">(</span><span class="n">daemon</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">// å®ˆæŠ¤çº¿ç¨‹Â Â Â Â Â Â Â  </span>
                    <span class="n">thread</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="n">daemon</span><span class="o">);</span><span class="err">Â Â Â Â Â </span>
                <span class="o">}</span><span class="err">Â Â Â Â Â </span>
                <span class="k">if</span> <span class="o">(</span><span class="n">priority</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">// ä¼˜å…ˆçº§Â Â Â Â Â Â Â  </span>
                    <span class="n">thread</span><span class="o">.</span><span class="na">setPriority</span><span class="o">(</span><span class="n">priority</span><span class="o">);</span><span class="err">Â Â Â Â Â </span> 
                <span class="o">}</span><span class="err">Â Â Â Â Â </span> 
                <span class="k">if</span> <span class="o">(</span><span class="n">uncaughtExceptionHandler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="err">Â Â Â Â Â </span>
                    <span class="n">thread</span><span class="o">.</span><span class="na">setUncaughtExceptionHandler</span><span class="o">(</span><span class="n">uncaughtExceptionHandler</span><span class="o">);</span><span class="err">Â Â Â Â Â </span>
                <span class="o">}</span><span class="err">Â Â Â Â Â </span> 
                <span class="k">return</span> <span class="n">thread</span><span class="o">;</span><span class="err">Â Â Â </span>
            <span class="o">}</span><span class="err">Â </span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h2 id="åˆ›å»ºçº¿ç¨‹æ± çš„æ­£ç¡®å§¿åŠ¿">åˆ›å»ºçº¿ç¨‹æ± çš„æ­£ç¡®å§¿åŠ¿</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** 
 * @Auther: Noseparte * @Date: 2019/11/27 10:35 
 * @Description: 
 * 
 *Â Â Â Â Â Â Â Â Â  &lt;p&gt;å®šåˆ¶åè®®ç½‘å…³çº¿ç¨‹æ± &lt;/p&gt; 
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPool</span> <span class="o">{</span><span class="err">Â Â Â </span> 

    <span class="kd">protected</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">Logger</span> <span class="n">_LOG</span> <span class="o">=</span> <span class="nc">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">ThreadPool</span><span class="o">.</span><span class="na">class</span><span class="o">);</span><span class="err">Â Â Â </span> 
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ExecutorService</span><span class="o">&gt;</span> <span class="n">workers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span><span class="err">Â Â Â </span> 
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">threadCount</span><span class="o">;</span><span class="err">Â Â Â </span> 
    <span class="kd">private</span> <span class="nc">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">ThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">threadCount</span><span class="o">)</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="k">this</span><span class="o">(</span><span class="n">threadCount</span><span class="o">,</span> <span class="k">new</span> <span class="nc">UserThreadFactory</span><span class="o">(</span><span class="s">"ç½‘å…³æ¸¸æˆé€»è¾‘åè®®çº¿ç¨‹æ± "</span><span class="o">));</span><span class="err">Â Â Â </span> 
    <span class="o">}</span><span class="err">Â Â Â </span> 
    
    <span class="kd">public</span> <span class="nf">ThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">threadCount</span><span class="o">,</span> <span class="nc">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">)</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="k">this</span><span class="o">.</span><span class="na">threadCount</span> <span class="o">=</span> <span class="n">threadCount</span><span class="o">;</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="k">this</span><span class="o">.</span><span class="na">threadFactory</span> <span class="o">=</span> <span class="n">threadFactory</span><span class="o">;</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="k">if</span> <span class="o">(</span><span class="n">threadCount</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="kc">null</span> <span class="o">==</span> <span class="n">threadFactory</span><span class="o">)</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">();</span><span class="err">Â Â Â Â Â Â Â </span> 
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threadCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
                <span class="n">workers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="n">threadCount</span><span class="o">,</span> <span class="mi">200</span><span class="o">,</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                    <span class="mi">0L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                    <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;(</span><span class="mi">1024</span><span class="o">),</span>
                    <span class="n">threadFactory</span><span class="o">,</span> 
                    <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">.</span><span class="na">AbortPolicy</span><span class="o">()));</span><span class="err">Â Â Â Â Â Â Â </span> 
            <span class="o">}</span><span class="err">Â Â Â </span> 
    <span class="o">}</span><span class="err">Â Â Â </span> 
    
    <span class="kd">public</span> <span class="nc">Future</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">task</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mold</span><span class="o">)</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">mold</span><span class="o">)</span> <span class="o">%</span> <span class="n">threadCount</span><span class="o">;</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">executor</span><span class="o">)</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span>
            <span class="n">_LOG</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"sid="</span> <span class="o">+</span> <span class="n">mold</span> <span class="o">+</span> <span class="s">", tid="</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span><span class="err">Â Â Â Â Â Â Â </span>
        <span class="o">}</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="k">return</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">task</span><span class="o">);</span><span class="err">Â Â Â </span> 
    <span class="o">}</span><span class="err">Â Â Â </span> 
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â </span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="k">for</span> <span class="o">(</span><span class="nc">ExecutorService</span> <span class="n">worker</span> <span class="o">:</span> <span class="n">workers</span><span class="o">)</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="n">_LOG</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"close thread{}."</span><span class="o">,</span> <span class="o">++</span><span class="n">count</span><span class="o">);</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="n">worker</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="o">}</span><span class="err">Â Â Â </span>
    <span class="o">}</span><span class="err">Â Â Â </span> 
    
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UserThreadFactory</span> <span class="kd">implements</span> <span class="nc">ThreadFactory</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">poolNumber</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ThreadGroup</span> <span class="n">group</span><span class="o">;</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">threadNumber</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">namePrefix</span><span class="o">;</span><span class="err">Â Â Â Â Â Â Â </span> 
        
        <span class="nc">UserThreadFactory</span><span class="o">(</span><span class="nc">String</span> <span class="n">poolName</span><span class="o">)</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="nc">SecurityManager</span> <span class="n">s</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">();</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="n">group</span> <span class="o">=</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">getThreadGroup</span><span class="o">()</span> <span class="o">:</span><span class="err">Â Â </span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getThreadGroup</span><span class="o">();</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="n">namePrefix</span> <span class="o">=</span> <span class="n">poolName</span> <span class="o">+</span> <span class="s">"-"</span> <span class="o">+</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                    <span class="n">poolNumber</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span> <span class="o">+</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                    <span class="s">"-thread-"</span><span class="o">;</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="o">}</span><span class="err">Â Â Â Â Â </span>
        
        <span class="kd">public</span> <span class="nc">Thread</span> <span class="nf">newThread</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="nc">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                <span class="n">namePrefix</span> <span class="o">+</span> <span class="n">threadNumber</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">(),</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                <span class="mi">0</span><span class="o">);</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">isDaemon</span><span class="o">())</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span> 
                <span class="n">t</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getPriority</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">NORM_PRIORITY</span><span class="o">)</span><span class="err">Â Â Â </span>
                <span class="n">t</span><span class="o">.</span><span class="na">setPriority</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">NORM_PRIORITY</span><span class="o">);</span><span class="err">Â Â Â Â Â Â Â Â Â Â Â </span> 
            <span class="k">return</span> <span class="n">t</span><span class="o">;</span><span class="err">Â Â Â Â Â Â Â </span> 
        <span class="o">}</span><span class="err">Â Â Â </span>
        
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<blockquote>
  <p><strong>åˆ›å»ºçº¿ç¨‹æ± çš„æ³¨æ„äº‹é¡¹ï¼š</strong></p>
  <ol>
    <li>æ ¹æ®ä¸šåŠ¡åœºæ™¯å®šåˆ¶ThreadFactoryã€é¥±å’Œç­–ç•¥ã€ä»»åŠ¡é˜Ÿåˆ—ã€ThreadPoolExecutor</li>
    <li>æ³¨æ„BlockingQueueä¸­ä»»åŠ¡é˜»å¡æ•°é‡è¶Šæ¥è¶Šå¤šä¼šå¯¼è‡´å†…å­˜è€—å°½(OOM), è¦è®¾ç½®é˜Ÿåˆ—çš„ä¸Šé™å€¼</li>
  </ol>
</blockquote>

<blockquote>
  <p><strong>æºç åœ°å€ï¼š</strong>
<a href="https://github.com/AwakenCN/Almost-Famous/blob/2b8e16c9476364d7a95aef228655382ac6a199e0/famous-common/src/main/java/com/noseparte/common/thread/ThreadPool.java#L70">Almost-Famous: æ¸¸æˆä¸­çš„ç½‘å…³çº¿ç¨‹æ± æ˜¯å¦‚ä½•åˆ›å»ºçš„</a></p>
</blockquote>

<blockquote>
  <p><strong>ç›¸å…³åšæ–‡ï¼šå‹æƒ…é“¾æ¥</strong>
<a href="https://zhuanlan.zhihu.com/p/32867181">ä¸€æ¬¡Javaçº¿ç¨‹æ± è¯¯ç”¨å¼•å‘çš„è¡€æ¡ˆå’Œæ€»ç»“</a>
<a href="https://blog.csdn.net/hollis_chuang/article/details/83743723">Javaä¸­çº¿ç¨‹æ± ï¼Œä½ çœŸçš„ä¼šç”¨å—ï¼Ÿ</a></p>
</blockquote>
:ET